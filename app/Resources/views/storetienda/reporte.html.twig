{% extends 'AvanzuAdminThemeBundle:layout:base-layout.html.twig' %}
{% block avanzu_document_title %}Storetiendas{% endblock %}
{% block avanzu_page_title %}Storetiendas{% endblock %}
{% block avanzu_page_subtitle %}{% if q is defined %}Filtrado por: {{q}}{% endif %}{% endblock %}
{% block titulo_pagina %}
  <!-- Content Header (Page header) -->
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">REPORTES DE VENTAS</h1>
        </div><!-- /.col -->
        <div class="col-sm-6">
                  </div><!-- /.col -->
      </div><!-- /.row -->
    </div><!-- /.container-fluid -->
  </div>
  <!-- /.content-header -->
{% endblock %}
{% block avanzu_page_content %}
<div id="search_report" class="p-3 row" style="display:block;">
  <div class="col-lg-6 col-12">
    <div>
      <label>Tipo de Reporte</label><br>
      <select id="reporteTipo" class="form-control" onchange="changeReporte();data_report();" value="Total">
        <option value="Total">Total Vendido</option>
        <option value="Categoria">Total Vendido X Categoria</option>
        <option value="Asesor">Total Vendido X Asesor</option>
        <option value="Top">Productos más vendidos</option>
      </select>
    </div>
    <div id="categoriasSelector" style="display:none;">
      <label>Categoria</label><br>
      <select id="Categoria" class="form-control" onchange="changeReporte();data_report();">
        {% for categoria in categorias %}
          <option value="{{ categoria }}">{{ categoria }}</option>
        {% endfor %}
      </select>
    </div>
    <div id="asesorselector" style="display:none;">
      <label>Asesor</label><br>
      <select id="Asesor" class="form-control" onchange="changeReporte();data_report();">
        {% for asesor in asesores %}
          <option value="{{ asesor }}">{{ asesor }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <form onsubmit="event.preventDefault(); request_reporte();data_report();">
        <div id="selector de fecha" class="mb-2">
            <label for="date">Fecha Inicial:</label>
            <input type="date" id="start" class="form-control">
            <label for="date">Fecha Final:</label> 
            <input type="date" id="stop" class="form-control">
        </div> 
        <button id="Traer_reporte" class="btn btn-success" style="display:block">Generar Reporte</button>   
      </form>
    </div>
  </div>
</div>
<div id="table_reporte" style="display:none">
  <h3>Resumen Reporte</h3>
  <div class="d-flex mb-1">
    <button id="Nuevo_reporte" class="btn btn-success no-print" style="display:none" onclick="new_Repot();">Nuevo Reporte</button>&nbsp;&nbsp;&nbsp;
    <a href="#!" onClick="window.print()" rel="noopener" class="btn btn-default no-print"><i class="fas fa-print"></i> Imprimir</a>&nbsp;&nbsp;&nbsp;
    <button id="export_xls" class="btn btn-primary no-print" style="display:none" onclick="ExportToExcel('xlsx');"><i class="fas fa-file-excel"></i> Exportar a Excel</button>
  </div>
  <table class="table table-sm table-bordered table-striped">
    <thead id="reporte_principal_head">

    </thead>
    <tbody id="reporte_principal">
      
    </tbody>
  </table>
  <br><h4 id="detail_tittle">Detalles de Reporte</h4>
  <div id="asesorSelector2">
    <label>Asesor</label><br>
    <select id="asesores2" class="form-control" onchange="changeSeller()" style="max-width:200px;">
      <option value="TODOS" selected>Todos</option>
      {% for asesor in asesores %}
        <option value="{{ asesor }}">{{ asesor }}</option>
      {% endfor %}
    </select><br>
  </div>
  <div id="categoriaDetalleBox">
    <div class="row">
      <div class="col-3" id="CategoriaDetalleRow">
          <label>Categoria</label><br>
          <select id="CategoriaDetalle" class="form-control" onchange="changeCategory();" style="max-width:200px;">
        </select>
      </div>
      <div class="col-3">
          <label>Referencia</label><br>
          <input type="text" class="form-control" id="refFilter" style="max-width:200px;" onchange="changeCategory();"/>
      </div>
      <div class="col-3">
          <label>Talla</label><br>
          <input type="text" class="form-control" id="tallaFilter" style="max-width:200px;" onchange="changeCategory();"/>
      </div>
      <div class="col-3">
          <label>Color</label><br>
          <input type="text" class="form-control" id="colorFilter" style="max-width:200px;" onchange="changeCategory();"/>
      </div>
    </div><br>
  </div>
  <table id="details" class="table table-sm table-bordered table-striped">
    <thead id="report_detail">

    </thead>
    <tbody id="detail_data">
      
    </tbody>
  </table>
</div>

{% endblock %}
{% block avanzu_javascripts_inline %}
  <script type="text/javascript" src="https://unpkg.com/xlsx@0.15.1/dist/xlsx.full.min.js"></script>
  <script> 
    var toleranciaKPI = 0.0;
    var kpiGenerales = null;
    var reporteData = [];
   function changeReporte(){
      let selectorValue = document.getElementById("reporteTipo").value;
      if(selectorValue=="Categoria"){
        document.getElementById("categoriasSelector").style.display = "block";
        document.getElementById("asesorselector").style.display = "none";
      }
      if(selectorValue=="Asesor"){
        document.getElementById("asesorselector").style.display = "block";
        document.getElementById("categoriasSelector").style.display = "none";
      }
      if(selectorValue=="Total"){
        document.getElementById("asesorselector").style.display = "none";
        document.getElementById("categoriasSelector").style.display = "none";
      }
      if(selectorValue=="Top"){
        document.getElementById("asesorselector").style.display = "none";
        document.getElementById("categoriasSelector").style.display = "none";
      }
   }
   function data_report(){
      let start_Date = document.getElementById("start").value;
      let stop_Date = document.getElementById("stop").value;
      let rtipo = document.getElementById("reporteTipo").value;
      let tag = (rtipo=="Total" || rtipo=="Top")? null:document.getElementById(rtipo).value;
   }
   
   function request_reporte(){
      let start_Date = document.getElementById("start").value;
      let stop_Date = document.getElementById("stop").value;
      if(start_Date && stop_Date){
        let rtipo = document.getElementById("reporteTipo").value;
        let tag = (rtipo=="Total" || rtipo=="Top")? null:document.getElementById(rtipo).value;
        let tipo = {
          start: start_Date,
          stop: stop_Date,
          reporte_tipo: rtipo,
          reporte_tag: tag,
        } 
        let ref = tipo;
        $.post(
          "{{ app.request.getSchemeAndHttpHost()}}/store/get_reporte",
          ref,
          function(reporte){
            reporte = reporte.filter(item => item.asesor !== 'MATEO CASTRO');
            reporteData = reporte;
            document.getElementById("CategoriaDetalle").innerHTML = "";
            showReporte(reporte,rtipo,start_Date,stop_Date,{category:"TODOS",refFilter:"",tallaFilter:"",colorFilter:""},tag)
          }
        )
      }
      else{
        alert("Debes indicar las fechas requeridas")
      }
    }
    function changeCategory(){
      let filters = {
        category:document.getElementById("CategoriaDetalle").value,
        refFilter:document.getElementById("refFilter").value,
        tallaFilter:document.getElementById("tallaFilter").value,
        colorFilter:document.getElementById("colorFilter").value,
      }
      let start_Date = document.getElementById("start").value;
      let stop_Date = document.getElementById("stop").value;
      let rtipo = document.getElementById("reporteTipo").value;
      let tag = (rtipo=="Total" || rtipo=="Top")? null:document.getElementById(rtipo).value;
      showReporte(reporteData,rtipo,start_Date,stop_Date,filters,tag,)
    }
    function changeSeller(){
      let asesor = document.getElementById("asesores2").value;
      let start_Date = document.getElementById("start").value;
      let stop_Date = document.getElementById("stop").value;
      let rtipo = document.getElementById("reporteTipo").value;
      let tag = (rtipo=="Total" || rtipo=="Top")? null:document.getElementById(rtipo).value;
      showReporte(reporteData,rtipo,start_Date,stop_Date,{category:asesor,refFilter:"",tallaFilter:"",colorFilter:""},tag)
    }
    function showReporte(reporte, rtipo, start_Date, stop_Date, filtros, tag) {
      document.getElementById("reporte_principal_head").innerHTML = "";
      document.getElementById("reporte_principal").innerHTML = "";
      document.getElementById("report_detail").innerHTML = "";
      document.getElementById("detail_data").innerHTML = "";
      
      let cantidad = 0;
      let totalPrendas = 0;
      let total = 0;
      let totalEnvios = 0;
      let totalNuevos = 0;
      let totalVentaNetaNuevos = 0;
      let totalAbonos = 0;
      let totalPagosCompletos = 0;
      let totalPagosRestantes = 0;
      let clientesNuevosUnicos = new Set();
      
      if (rtipo == "Total") {
        document.getElementById("asesorSelector2").style.display = "block";
        document.getElementById("categoriaDetalleBox").style.display = "none";
        document.getElementById("CategoriaDetalleRow").style.display = "none";
        document.getElementById("table_reporte").style.display = "block";
        document.getElementById("detail_tittle").style.display = "block";
        document.getElementById("Traer_reporte").style.display = "none";
        document.getElementById("search_report").style.display = "none";
        document.getElementById("Nuevo_reporte").style.display = "block";
        document.getElementById("export_xls").style.display = "block";
        
        $("#reporte_principal_head").append(
            '<tr id="reporte_data">' +
                '<th class="nowrap">Tipo Reporte</th>' +
                '<th class="nowrap">Fecha de Inicio</th>' +
                '<th class="nowrap">Fecha de Cierre</th>' +
                '<th class="nowrap">Número de transacciones</th>' +
                '<th class="nowrap">Total de unidades</th>' +
                '<th class="nowrap">Total efectivo recibido</th>' +
                '<th class="nowrap">Total costo envios</th>' +
                '<th class="nowrap">Gran total</th>' +
            '</tr>'
        );
        
        $("#report_detail").append(
          '<tr id="instances">' +
            '<th class="nowrap text-center">Order ID</th>' +
            '<th class="nowrap text-center">Fecha</th>' +
            '<th class="nowrap text-center">Tipo Transacción</th>' +
            '<th class="nowrap text-center">Tipo cliente</th>' +
            '<th class="nowrap text-center">Estado cliente</th>' +
            '<th class="nowrap text-center">Monto Transacción</th>' +
            '<th class="nowrap text-center">Costo envío</th>' +
            '<th class="nowrap text-center">Total Factura</th>' +
          '</tr>'
        );

        for (let i = 0; i < reporte.length; i++) {
          if (filtros.category !== "TODOS" && reporte[i].asesor !== filtros.category) {
            continue;
          }
          
          cantidad++;
          const montoTransaccion = parseFloat(reporte[i].monto_transaccion) || 0;
          const shipmentCost = parseFloat(reporte[i].shipment_cost) || 0;
          const price = parseFloat(reporte[i].price) || 0;
          totalEnvios += reporte[i].shipment_cost;
          total += reporte[i].monto_transaccion;

          if (reporte[i].tipo_transaccion === 'Pago Completo') {
            totalPagosCompletos += reporte[i].monto_transaccion;
          } else if (reporte[i].tipo_transaccion.includes('Abono')) {
            totalAbonos += reporte[i].monto_transaccion;
          } else if (reporte[i].tipo_transaccion === 'Pago Restante') {
            totalPagosRestantes += reporte[i].monto_transaccion;
          }
          
          if (reporte[i].client_type === 'Nuevo') {
            totalNuevos++;
            totalVentaNetaNuevos += reporte[i].monto_transaccion;
            if (reporte[i].cliente_id) {
              clientesNuevosUnicos.add(reporte[i].cliente_id);
            }
          }

          let factorProporcional = price > 0 ? montoTransaccion / price : 0;
          reporte[i].items.forEach(item => {
            totalPrendas += (item.product_qty * factorProporcional);
          });
          
          $("#detail_data").append(
            '<tr id="data' + i + '">' +
              '<td class="nowrap text-center">' + (reporte[i].original_id || reporte[i].id) + '</td>' +
              '<td class="nowrap text-center">' + reporte[i].date + '</td>' +
              '<td class="nowrap text-center"><span class="badge ' + getTipoTransaccionClass(reporte[i].tipo_transaccion) + '">' + reporte[i].tipo_transaccion + '</span></td>' +
              '<td class="nowrap text-center">' + reporte[i].client_type + '</td>' +
              '<td class="nowrap text-center">' + reporte[i].client_state + '</td>' +
              '<td class="nowrap text-center">' + montoTransaccion.toFixed(2) + '</td>' +
              '<td class="nowrap text-center">' + shipmentCost.toFixed(2) + '</td>' +
              '<td class="nowrap text-center">' + price.toFixed(2) + '</td>' +
            '</tr>'
          );
        }

        const ticketPromedio = cantidad > 0 ? total / cantidad : 0;
        const unidadesPorVenta = cantidad > 0 ? totalPrendas / cantidad : 0;

        if (filtros.category === "TODOS") {
            kpiGenerales = {
                ticketPromedio: ticketPromedio,
                unidadesPorVenta: unidadesPorVenta
            };
        }

        $("#reporte_principal").append(
            '<tr>' +
                '<td class="nowrap">' + rtipo + '</td>' +
                '<td class="nowrap">' + start_Date + '</td>' +
                '<td class="nowrap">' + stop_Date + '</td>' +
                '<td class="nowrap">' + cantidad + '</td>' +
                '<td class="nowrap">' + totalPrendas.toFixed(0) + '</td>' +
                '<td class="nowrap">' + total.toFixed(2) + '</td>' +
                '<td class="nowrap">' + totalEnvios.toFixed(2) + '</td>' +
                '<td class="nowrap">' + (totalEnvios + total).toFixed(2) + '</td>' +
            '</tr>'
        );

        $("#reporte_principal").append(
            '<tr class="table-info">' +
                '<td colspan="2" class="nowrap"><strong>Desglose Transacciones</strong></td>' +
                '<td class="nowrap">Pagos Completos:</td>' +
                '<td class="nowrap">' + totalPagosCompletos.toFixed(2) + '</td>' +
                '<td class="nowrap">Abonos:</td>' +
                '<td class="nowrap">' + totalAbonos.toFixed(2) + '</td>' +
                '<td class="nowrap">Pagos Restantes:</td>' +
                '<td class="nowrap">' + totalPagosRestantes.toFixed(2) + '</td>' +
            '</tr>'
        );

        let kpiRow = '';
        if (filtros.category !== "TODOS" && kpiGenerales) {
            const minTicket = kpiGenerales.ticketPromedio * (1 - toleranciaKPI);
            const minUnidades = kpiGenerales.unidadesPorVenta * (1 - toleranciaKPI);

            const claseTicket = ticketPromedio >= minTicket ? 'text-success' : 'text-danger';
            const claseUnidades = unidadesPorVenta >= minUnidades ? 'text-success' : 'text-danger';
            
            kpiRow = '<tr>' +
                '<td colspan="2" class="nowrap"><strong>KPIs</strong></td>' +
                '<td class="nowrap">Ticket Promedio:</td>' +
                '<td class="nowrap ' + claseTicket + '"><strong>' +
                    ticketPromedio.toFixed(2) +
                    ' (Meta: ' + minTicket.toFixed(2) + ')' +
                '</strong></td>' +
                '<td class="nowrap">Unidades por Transacción:</td>' +
                '<td class="nowrap ' + claseUnidades + '"><strong>' + 
                    unidadesPorVenta.toFixed(2) + 
                    ' (Meta: ' + minUnidades.toFixed(2) + ')' +
                '</strong></td>' +
                '<td colspan="2"></td>' +
            '</tr>';
        } else {
            kpiRow = '<tr>' +
                '<td colspan="2" class="nowrap"><strong>KPIs</strong></td>' +
                '<td class="nowrap">Ticket Promedio:</td>' +
                '<td class="nowrap">' + ticketPromedio.toFixed(2) + '</td>' +
                '<td class="nowrap">Unidades por Transacción:</td>' +
                '<td class="nowrap">' + unidadesPorVenta.toFixed(2) + '</td>' +
                '<td colspan="2"></td>' +
            '</tr>';
        }
        $("#reporte_principal").append(kpiRow);

        $("#reporte_principal").append(
            '<tr>' +
                '<td colspan="2" class="nowrap"><strong>Nuevos Clientes</strong></td>' +
                '<td class="nowrap">Clientes Únicos:</td>' +
                '<td class="nowrap">' + clientesNuevosUnicos.size + '</td>' +
                '<td class="nowrap">Transacciones:</td>' +
                '<td class="nowrap">' + totalNuevos + '</td>' +
                '<td class="nowrap">Efectivo:</td>' +
                '<td class="nowrap">' + totalVentaNetaNuevos.toFixed(2) + '</td>' +
            '</tr>'
        );
      }
      else if(rtipo=="Categoria"){
        document.getElementById("asesorSelector2").style.display = "none";
        document.getElementById("categoriaDetalleBox").style.display = "block";
        document.getElementById("CategoriaDetalleRow").style.display = "none";
        document.getElementById("table_reporte").style.display = "block";
        document.getElementById("detail_tittle").style.display = "block";
        document.getElementById("Traer_reporte").style.display = "none";
        document.getElementById("search_report").style.display = "none";
        document.getElementById("Nuevo_reporte").style.display = "block";
        document.getElementById("export_xls").style.display = "block";
        $("#reporte_principal_head").append(
            '<tr>' +
                '<th class="nowrap">Tipo Reporte</th>' +
                '<th class="nowrap">Fecha de Inicio</th>' +
                '<th class="nowrap">Fecha de Cierre</th>' +
                '<th class="nowrap">Número de transacciones</th>' +
                '<th class="nowrap">Total de unidades</th>' +
                '<th class="nowrap">Total efectivo recibido</th>' +
                '<th class="nowrap">Gran total</th>' +
            '</tr>'
        );
        $("#report_detail").append(
          '<tr id="instances">'+
            '<th class="nowrap">'+'Categoria'+'</th>'+
            '<th class="nowrap">'+'Referencia'+'</th>'+
            '<th class="nowrap">'+'Talla'+'</th>'+
            '<th class="nowrap">'+'Color'+'</th>'+
            '<th class="nowrap">'+'Cantidad'+'</th>'+
            '<th class="nowrap">'+'Valor'+'</th>'+
          '</tr>'
        );
        let categoriasR = {};
        let itemsReport = {};
        let totalUnid = 0;
        for(let i=0; i < reporte.length; i++) {
          const montoTransaccion = parseFloat(reporte[i].monto_transaccion) || 0;
          const shipmentCost = parseFloat(reporte[i].shipment_cost) || 0;
          const price = parseFloat(reporte[i].price) || 0;
          
          totalEnvios += shipmentCost;
          total += montoTransaccion; 
          cantidad++;
          
          let factorProporcional = price > 0 ? montoTransaccion / price : 0;
          
          reporte[i].items.forEach(item=>{
            categoriasR[item.Categoría] = item.Categoría
            if(!itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color]&&item.Categoría == tag
              &&(filtros.refFilter!=""?(item.product_ref==filtros.refFilter?true:false):true)
              &&(filtros.tallaFilter!=""?(item.product_talla==filtros.tallaFilter?true:false):true)
              &&(filtros.colorFilter!=""?(item.product_color==filtros.colorFilter?true:false):true)
            ){
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color] = item;
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color].qty = 0;
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color].val = 0;
            }
          })
          reporte[i].items.forEach(item=>{
            if(item.Categoría == tag
              &&(filtros.refFilter!=""?(item.product_ref==filtros.refFilter?true:false):true)
              &&(filtros.tallaFilter!=""?(item.product_talla==filtros.tallaFilter?true:false):true)
              &&(filtros.colorFilter!=""?(item.product_color==filtros.colorFilter?true:false):true)
            ){
              let cantidadReal = parseFloat(item.product_qty) || 0;
              let valorReal = parseFloat(item.product_price) * cantidadReal || 0;
              
              totalUnid += cantidadReal;
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color].qty += cantidadReal;
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color].val += valorReal;
            }
          }) 
        }
        let itemsArray = [];
        Object.keys(itemsReport).forEach(itemR=>{
          itemsArray.push(itemsReport[itemR]);
        })
        Object.keys(categoriasR).forEach(cat=>{
          if(!document.getElementById('cat_'+cat)){
            $("#CategoriaDetalle").append(
              '<option id="cat_'+cat+'" value="'+cat+'">'+cat+'</option>'
            );
          }
        })
        $("#reporte_principal").append(
            '<tr>' +
                '<td class="nowrap">' + rtipo + ' : ' + tag + '</td>' +
                '<td class="nowrap">' + start_Date + '</td>' +
                '<td class="nowrap">' + stop_Date + '</td>' +
                '<td class="nowrap">' + cantidad + '</td>' +
                '<td class="nowrap">' + totalUnid.toFixed(2) + '</td>' +
                '<td class="nowrap">' + (total - totalEnvios).toFixed(2) + '</td>' +
                '<td class="nowrap">' + total.toFixed(2) + '</td>' +
            '</tr>'
        );
        itemsArray.sort((a,b)=>b.qty-a.qty);
        itemsArray.forEach(item=>{
          $("#detail_data").append(
            '<tr id="data'+item.product_ref+"_"+item.product_talla+"_"+item.product_color+'">'+
              '<td class="nowrap">'+item.Categoría+'</td>'+
              '<td class="nowrap">'+item.product_ref+'</td>'+
              '<td class="nowrap">'+item.product_talla+'</td>'+
              '<td class="nowrap">'+item.product_color+'</td>'+
              '<td class="nowrap">'+item.qty.toFixed(2)+'</td>'+
              '<td class="nowrap">'+item.val.toFixed(2)+'</td>'+
            '</tr>'
          );    
        }) 
      }
      else if(rtipo=="Asesor"){
        document.getElementById("asesorSelector2").style.display = "none";
        document.getElementById("categoriaDetalleBox").style.display = "block";
        document.getElementById("CategoriaDetalleRow").style.display = "block";
        document.getElementById("table_reporte").style.display = "block";
        document.getElementById("detail_tittle").style.display = "block";
        document.getElementById("Traer_reporte").style.display = "none";
        document.getElementById("search_report").style.display = "none";
        document.getElementById("Nuevo_reporte").style.display = "block";
        document.getElementById("export_xls").style.display = "block";
        $("#reporte_principal_head").append(
            '<tr>' +
                '<th class="nowrap">Tipo Reporte</th>' +
                '<th class="nowrap">Fecha de Inicio</th>' +
                '<th class="nowrap">Fecha de Cierre</th>' +
                '<th class="nowrap">Número de transacciones</th>' +
                '<th class="nowrap">Total de unidades</th>' +
                '<th class="nowrap">Total efectivo recibido</th>' +
                '<th class="nowrap">Gran total</th>' +
            '</tr>'
        );
        $("#report_detail").append(
          '<tr id="instances">'+
            '<th class="nowrap">'+'Categoria'+'</th>'+
            '<th class="nowrap">'+'Referencia'+'</th>'+
            '<th class="nowrap">'+'Talla'+'</th>'+
            '<th class="nowrap">'+'Color'+'</th>'+
            '<th class="nowrap">'+'Cantidad'+'</th>'+
            '<th class="nowrap">'+'Valor'+'</th>'+
          '</tr>'
        );
        let categoriasR = {};
        let itemsReport = {};
        let totalUnid = 0;
        for(let i=0; i < reporte.length; i++) {
          totalEnvios += reporte[i].shipment_cost;
          total += reporte[i].monto_transaccion; 
          cantidad++;
          
          let factorProporcional = price > 0 ? montoTransaccion / price : 0;
          
          reporte[i].items.forEach(item=>{
            if(!itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color]&&item.Categoría == filtros.category
              &&(filtros.refFilter!=""?(item.product_ref==filtros.refFilter?true:false):true)
              &&(filtros.tallaFilter!=""?(item.product_talla==filtros.tallaFilter?true:false):true)
              &&(filtros.colorFilter!=""?(item.product_color==filtros.colorFilter?true:false):true)
            ){
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color] = item;
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color].qty = 0;
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color].val = 0;
            }
            else if(!itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color]&&filtros.category == "TODOS"
              &&(filtros.refFilter!=""?(item.product_ref==filtros.refFilter?true:false):true)
              &&(filtros.tallaFilter!=""?(item.product_talla==filtros.tallaFilter?true:false):true)
              &&(filtros.colorFilter!=""?(item.product_color==filtros.colorFilter?true:false):true)
            ){
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color] = item;
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color].qty = 0;
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color].val = 0;
            }
          })
          reporte[i].items.forEach(item=>{
            if(item.Categoría == filtros.category
              &&(filtros.refFilter!=""?(item.product_ref==filtros.refFilter?true:false):true)
              &&(filtros.tallaFilter!=""?(item.product_talla==filtros.tallaFilter?true:false):true)
              &&(filtros.colorFilter!=""?(item.product_color==filtros.colorFilter?true:false):true)
            ){
              let cantidadProporcional = item.product_qty * factorProporcional;
              let valorProporcional = item.product_price * cantidadProporcional;
              
              categoriasR[item.Categoría] = item.Categoría;
              totalUnid += cantidadProporcional;
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color].qty += cantidadProporcional;
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color].val += valorProporcional;
            }
            else if(filtros.category == "TODOS"
              &&(filtros.refFilter!=""?(item.product_ref==filtros.refFilter?true:false):true)
              &&(filtros.tallaFilter!=""?(item.product_talla==filtros.tallaFilter?true:false):true)
              &&(filtros.colorFilter!=""?(item.product_color==filtros.colorFilter?true:false):true)
            ){
              let cantidadProporcional = item.product_qty * factorProporcional;
              let valorProporcional = item.product_price * cantidadProporcional;
              
              categoriasR[item.Categoría] = item.Categoría;
              totalUnid += cantidadProporcional;
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color].qty += cantidadProporcional;
              itemsReport[item.product_ref+"_"+item.product_talla+"_"+item.product_color].val += valorProporcional;
            }
          })   
        }
        let itemsArray = [];
        Object.keys(itemsReport).forEach(itemR=>{
          itemsArray.push(itemsReport[itemR]);
        })
        if(!document.getElementById('cat_TODOS')){
          $("#CategoriaDetalle").append(
            '<option id="cat_TODOS" value="TODOS" selected>TODOS</option>'
          );
        }
        Object.keys(categoriasR).forEach(cat=>{
          if(!document.getElementById('cat_'+cat)){
            $("#CategoriaDetalle").append(
              '<option id="cat_'+cat+'" value="'+cat+'">'+cat+'</option>'
            );
          }
        })
        itemsArray.sort((a,b)=>b.qty-a.qty);
        itemsArray.forEach(item=>{
          $("#detail_data").append(
            '<tr id="data'+item.product_ref+"_"+item.product_talla+"_"+item.product_color+'">'+
              '<td class="nowrap">'+item.Categoría+'</td>'+
              '<td class="nowrap">'+item.product_ref+'</td>'+
              '<td class="nowrap">'+item.product_talla+'</td>'+
              '<td class="nowrap">'+item.product_color+'</td>'+
              '<td class="nowrap">'+item.qty.toFixed(2)+'</td>'+
              '<td class="nowrap">'+item.val.toFixed(2)+'</td>'+
            '</tr>'
          );    
        })

        const ticketPromedio = cantidad > 0 ? total / cantidad : 0;
        const unidadesPorVenta = cantidad > 0 ? totalUnid / cantidad : 0;

        $("#reporte_principal").append(
            '<tr>' +
                '<td class="nowrap">' + rtipo + ' : ' + tag + '</td>' +
                '<td class="nowrap">' + start_Date + '</td>' +
                '<td class="nowrap">' + stop_Date + '</td>' +
                '<td class="nowrap">' + cantidad + '</td>' +
                '<td class="nowrap">' + totalUnid.toFixed(2) + '</td>' +
                '<td class="nowrap">' + (total - totalEnvios).toFixed(2) + '</td>' +
                '<td class="nowrap">' + total.toFixed(2) + '</td>' +
            '</tr>'
        );

        $("#reporte_principal").append(
            '<tr>' +
                '<td colspan="2" class="nowrap"><strong>KPIs</strong></td>' +
                '<td class="nowrap">Ticket Promedio:</td>' +
                '<td class="nowrap">' + ticketPromedio.toFixed(2) + '</td>' +
                '<td class="nowrap">Unidades por Transacción:</td>' +
                '<td class="nowrap">' + unidadesPorVenta.toFixed(2) + '</td>' +
                '<td></td>' + 
            '</tr>'
        );
      }
      else if(rtipo=="Top"){
        document.getElementById("asesorSelector2").style.display = "none";
        document.getElementById("categoriaDetalleBox").style.display = "none";
        document.getElementById("CategoriaDetalleRow").style.display = "none";
        reporte.sort((a,b) => (a.cantidad < b.cantidad) ? 1 : ((b.cantidad < a.cantidad) ? -1 : 0));
        $("#reporte_principal_head").append(
            '<tr>' +
                '<th class="nowrap">Referencia</th>' +
                '<th class="nowrap">Talla</th>' +
                '<th class="nowrap">Color</th>' +
                '<th class="nowrap">Fecha de Inicio</th>' +
                '<th class="nowrap">Fecha de Cierre</th>' +
                '<th class="nowrap">Número de ventas</th>' +
                '<th class="nowrap">Total vendido</th>' +
            '</tr>'
        );
        for(let i = 0; i < reporte.length; i++) {
            $("#reporte_principal").append(
                '<tr>' +
                    '<td class="nowrap">' + reporte[i].nombre + '</td>' +
                    '<td class="nowrap">' + reporte[i].talla + '</td>' +
                    '<td class="nowrap">' + reporte[i].color + '</td>' +
                    '<td class="nowrap">' + start_Date + '</td>' +
                    '<td class="nowrap">' + stop_Date + '</td>' +
                    '<td class="nowrap">' + reporte[i].cantidad.toFixed(2) + '</td>' +
                    '<td class="nowrap">' + reporte[i].total.toFixed(2) + '</td>' +
                '</tr>'
            );
        }
        document.getElementById("table_reporte").style.display = "block";
        document.getElementById("detail_tittle").style.display = "none";
        document.getElementById("Traer_reporte").style.display = "none";
        document.getElementById("search_report").style.display = "none";
        document.getElementById("Nuevo_reporte").style.display = "block";
        document.getElementById("export_xls").style.display = "block";
      }
    }
    
    function getTipoTransaccionClass(tipoTransaccion) {
      switch(tipoTransaccion) {
        case 'Pago Completo':
          return 'badge-success';
        case 'Abono 1':
        case 'Abono 2':
          return 'badge-warning';
        case 'Pago Restante':
          return 'badge-info';
        default:
          return 'badge-secondary';
      }
    }
    
    function new_Repot() {
      let reset_report = document.getElementById("reporte_data");
      document.getElementById("detail_data").innerHTML = "";
      document.getElementById("report_detail").innerHTML = "";
      document.getElementById("reporte_principal_head").innerHTML = "";
      document.getElementById("reporte_principal").innerHTML = "";

      document.getElementById("asesores2").value = "";
      if(document.getElementById("Categoria")) document.getElementById("Categoria").value = "";
      if(document.getElementById("Asesor")) document.getElementById("Asesor").value = "";

      document.getElementById("table_reporte").style.display = "none";
      document.getElementById("Traer_reporte").style.display = "block";
      document.getElementById("Nuevo_reporte").style.display = "none";
      document.getElementById("export_xls").style.display = "none";
      document.getElementById("search_report").style.display = "block";
    }
    function ExportToExcel(type, fn, dl) {
        var wb = XLSX.utils.book_new();
        var elt = document.getElementById('details');
        var ws1 = XLSX.utils.table_to_sheet(elt);
        XLSX.utils.book_append_sheet(wb, ws1, "Transacciones");

        let rtipo = document.getElementById("reporteTipo").value;
        if (rtipo == "Total") {
            var clientesNuevosData = [];
            var clientesUnicos = new Map();
            reporteData.forEach(function(transaccion) {
                if (transaccion.client_type === 'Nuevo' && transaccion.cliente_id) {
                    if (!clientesUnicos.has(transaccion.cliente_id)) {
                        clientesUnicos.set(transaccion.cliente_id, {
                            'Cliente ID': transaccion.cliente_id,
                            'Nombre': transaccion.cliente_nombre || '',
                            'Apellidos': transaccion.cliente_apellidos || '',
                            'Email': transaccion.cliente_email || '',
                            'Teléfono': transaccion.cliente_telefono || '',
                            'Asesor': transaccion.asesor || '',
                            'Estado': transaccion.client_state || '',
                            'Primera Compra': transaccion.date,
                            'Total Gastado': 0,
                            'Transacciones': 0
                        });
                    }
                    var cliente = clientesUnicos.get(transaccion.cliente_id);
                    cliente['Total Gastado'] += parseFloat(transaccion.monto_transaccion) || 0;
                    cliente['Transacciones'] += 1;
                }
            });
            clientesUnicos.forEach(function(cliente) {
                cliente['Total Gastado'] = cliente['Total Gastado'].toFixed(2);
                clientesNuevosData.push(cliente);
            });
            clientesNuevosData.sort((a, b) => parseFloat(b['Total Gastado']) - parseFloat(a['Total Gastado']));
            if (clientesNuevosData.length > 0) {
                var ws2 = XLSX.utils.json_to_sheet(clientesNuevosData);

                ws2['!cols'] = [
                    {wch: 12},
                    {wch: 20},
                    {wch: 20},
                    {wch: 30},
                    {wch: 15},
                    {wch: 20},
                    {wch: 15},
                    {wch: 12}, 
                    {wch: 12}, 
                    {wch: 12}
                ];
                XLSX.utils.book_append_sheet(wb, ws2, "Clientes Nuevos");
            }
        }
        let start_Date = document.getElementById("start").value;
        let stop_Date = document.getElementById("stop").value;
        let asesor = document.getElementById("asesores2")?.value;
        let tag = (rtipo=="Total" || rtipo=="Top")? "":document.getElementById(rtipo).value;
        
        return dl ?
            XLSX.write(wb, { bookType: type, bookSST: true, type: 'base64' }) :
            XLSX.writeFile(wb, fn || (rtipo +(asesor?'-'+asesor:'')+(tag!=""?" "+tag:"") + ' '+start_Date +' a '+stop_Date + '.'+(type || 'xlsx')));
    }
  </script>
{% endblock %}